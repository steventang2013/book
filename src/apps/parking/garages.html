<!DOCTYPE html>
  <html>
    <head>
      <!--Import Google Icon Font-->
      <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
      <!--Import materialize.css-->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/css/materialize.min.css">

      <!--Let browser know website is optimized for mobile-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    </head>

    <body>
      <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.5/js/materialize.min.js"></script>
      <script src="https://cdn.firebase.com/js/client/2.3.2/firebase.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.0.0/lodash.min.js"></script>

      <nav>
        <div class="nav-wrapper teal lighten-2">
          <div class="container">
            <a href="index.html" class="brand-logo">SF Garage Space</a>
            <a href="#" data-activates="mobile-demo" class="button-collapse"><i class="material-icons">menu</i></a>
            <ul class="right hide-on-med-and-down">
              <li><a href="garages.html"><i class="small material-icons">list</i>List</a></li>
              <li><a href="garages_map.html"><i class="small material-icons">navigation</i>Map</a></li>
            </ul>
            <ul class="side-nav" id="mobile-demo">
              <li><a href="garages.html"><i class="small material-icons">list</i>List</a></li>
              <li><a href="garages_map.html"><i class="small material-icons">navigation</i>Map</a></li>
            </ul>
          </div>
        </div>
      </nav>

      <div class="container">

        <h1>Garages</h1>
        <ul class="collapsible popout" data-collapsible="accordion" id="garages">
        </ul>

      </div>

      <script>

      // create a firebase reference to the root
      var ref = new Firebase('https://publicdata-parking.firebaseio.com');

      var data

      // read data from the location san_francisco/garages, only once
      ref.child('san_francisco/garages').once('value', function(snapshot){
        data = snapshot.val()
        console.log('data is loaded', data)

        // filter the data
        var garages = _.filter(data, function(d){
            // keep only those values (d) that has "open_spaces" as a field
            return _.has(d, 'open_spaces')
        })

        displayGarages(garages)
      })

      function displayGarages(garages){
        // lodash _.forEach https://lodash.com/docs#forEach
        _.forEach(garages, function(val, key){
          var txtInsrt = [];
          var i = 0;
          var hours = val['hours'];
          var hrsLength = hours.length;
          var rates = val['rates'];
          var rateLength = rates.length;


          txtInsrt[i++] = '<li class="collection-item"><div class="collapsible-header">' + val['friendlyName'] + '</div><div class="collapsible-body"><p><b>Open Spaces: </b> ' + val['open_spaces'] + '/' + val['total_spaces'] + '<br><b>Hours: </b>';

          if(hrsLength){
            for (var a = 0; a < hrsLength; a += 1) {
              txtInsrt[i++] = '<br>';
              if(hours[a]['FROM'] != null){
                txtInsrt[i++] = hours[a]['FROM'];}
              if(hours[a]['TO'] != null){
                txtInsrt[i++] = ' to ';
                txtInsrt[i++] = hours[a]['TO'];}
              if(hours[a]['BEG'] != null){
                txtInsrt[i++] = ', ';
                txtInsrt[i++] = hours[a]['BEG'];}
              if(hours[a]['END'] != null){
                txtInsrt[i++] = ' to ';
                txtInsrt[i++] = hours[a]['END'];}
            }
          }
          else{
            txtInsrt[i++] = '<br>';
            if(hours['FROM'] != null){
              txtInsrt[i++] = hours['FROM'];}
            if(hours['TO'] != null){
              txtInsrt[i++] = ' to ';
              txtInsrt[i++] = hours['TO'];}
            if(hours['BEG'] != null){
              txtInsrt[i++] = ', ';
              txtInsrt[i++] = hours['BEG'];}
            if(hours['END'] != null){
              txtInsrt[i++] = ' to ';
              txtInsrt[i++] = hours['END'];}
          }

          txtInsrt[i++] = '<br><b>Rates: </b>';

          if(rateLength){
            for (var a2 = 0; a2 < rateLength; a2 += 1) {
              txtInsrt[i++] = '<br>';
              if(rates[a2]['BEG'] != null){
                txtInsrt[i++] = rates[a2]['BEG'];}
              if(rates[a2]['END'] != null){
                txtInsrt[i++] = ' to ';
                txtInsrt[i++] = rates[a2]['END'];}
              if(rates[a2]['DESC'] != null){
                txtInsrt[i++] = rates[a2]['DESC'];}
              if(rates[a2]['RATE'] != null){
                txtInsrt[i++] = ',   ';
                txtInsrt[i++] = '   $';
                txtInsrt[i++] = rates[a2]['RATE'];}
              if(rates[a2]['RQ'] != null){
                txtInsrt[i++] = '   ';
                txtInsrt[i++] = rates[a2]['RQ'];}
              if(rates[a2]['RR'] != null){
                txtInsrt[i++] = ',   ';
                txtInsrt[i++] = rates[a2]['RR'];}
            }
          }
          txtInsrt[i++] = '</p></div></li> ';
          $('#garages').append(txtInsrt.join(''));
        })
      }
      </script>
    </body>
  </html>
